{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\r\n\r\nconst globalForPrisma = globalThis as unknown as {\r\n  prisma?: PrismaClient\r\n}\r\n\r\nexport const prisma =\r\n  globalForPrisma.prisma ??\r\n  new PrismaClient({\r\n    log:\r\n      process.env.NODE_ENV === \"development\"\r\n        ? [\"error\", \"warn\"]\r\n        : [\"error\"],\r\n  })\r\n\r\nif (process.env.NODE_ENV !== \"production\") {\r\n  globalForPrisma.prisma = prisma\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KACE,uCACI;QAAC;QAAS;KAAO,GACjB;AACR;AAEF,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B"}},
    {"offset": {"line": 72, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/app/api/bids/%5Bid%5D/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\r\nimport { prisma } from \"@/lib/prisma\"\r\n\r\nexport const runtime = \"nodejs\"\r\nexport const dynamic = \"force-dynamic\"\r\n\r\ntype ParamsObj = Record<string, string | string[]>\r\ntype Ctx = { params: Promise<ParamsObj> | ParamsObj }\r\n\r\nfunction errorJson(message: string, status = 400) {\r\n  return NextResponse.json({ error: message }, { status })\r\n}\r\n\r\nasync function getIdFromCtx(ctx: Ctx): Promise<string | undefined> {\r\n  const params = await Promise.resolve(ctx.params)\r\n  const direct = (params[\"id\"] as any) ?? (params[\"bidId\"] as any) ?? (params[\"sessionId\"] as any)\r\n  const value = direct ?? Object.values(params)[0]\r\n  if (!value) return undefined\r\n  return Array.isArray(value) ? value[0] : value\r\n}\r\n\r\nfunction mapSessionForUI(session: any) {\r\n  const app: any = session.application\r\n  const tech: any = app?.technicalDetails ?? {}\r\n  const acceptedBid = (session.bids ?? []).find((b: any) => b.status === \"accepted\") ?? null\r\n\r\n  return {\r\n    id: session.id,\r\n    status: session.status,\r\n    bidType: session.bidType ?? \"open\",\r\n    requirements: session.requirements ?? null,\r\n    maxBudget: session.maxBudget ?? null,\r\n    startedAt: session.startedAt,\r\n    expiresAt: session.expiresAt,\r\n    selectedBidId: acceptedBid?.id ?? null, // computed for UI\r\n\r\n    bids: (session.bids ?? []).map((b: any) => ({\r\n      id: b.id,\r\n      status: b.status,\r\n      price: b.price,\r\n      proposal: b.proposal,\r\n      warranty: b.warranty,\r\n      estimatedDays: b.estimatedDays,\r\n      createdAt: b.createdAt,\r\n      updatedAt: b.updatedAt,\r\n\r\n      installerName: b.organization?.name ?? b.installer?.name ?? \"Installer\",\r\n      installerRating: b.organization?.rating ?? 0,\r\n      completedProjects: b.organization?.completedInstallations ?? 0,\r\n\r\n      packageId: b.packageId ?? null,\r\n      packageName: b.package?.name ?? null,\r\n\r\n      contact: {\r\n        phone: b.organization?.phone ?? null,\r\n        email: b.installer?.email ?? null,\r\n      },\r\n    })),\r\n\r\n    applicationDetails: {\r\n      address: tech.siteAddress || tech.address || app?.address || null,\r\n      capacity: tech.desiredCapacity != null ? `${tech.desiredCapacity} kW` : null,\r\n      customerPhone: app?.customer?.phone ?? null,\r\n      customerEmail: app?.customer?.email ?? null,\r\n    },\r\n  }\r\n}\r\n\r\nexport async function GET(_req: Request, ctx: Ctx) {\r\n  try {\r\n    const id = await getIdFromCtx(ctx)\r\n    if (!id) return errorJson(\"Bid session id is required\", 400)\r\n\r\n    const session = await prisma.bidSession.findUnique({\r\n      where: { id },\r\n      include: {\r\n        application: { include: { customer: true } },\r\n        bids: {\r\n          include: { installer: true, organization: true, package: true },\r\n          orderBy: { updatedAt: \"desc\" },\r\n        },\r\n      },\r\n    })\r\n\r\n    if (!session) return errorJson(\"Bid session not found\", 404)\r\n\r\n    return NextResponse.json(mapSessionForUI(session), { status: 200 })\r\n  } catch (e) {\r\n    console.error(\"GET /api/bids/[id] error:\", e)\r\n    return NextResponse.json({ error: e instanceof Error ? e.message : \"Failed\" }, { status: 500 })\r\n  }\r\n}\r\n\r\n/**\r\n * Customer accept/reject\r\n * Body: { action: \"accept\" | \"reject\", bidId: string }\r\n *\r\n * ACCEPT will:\r\n * - accept chosen bid, reject others\r\n * - close bid session\r\n * - create invoice (installation)\r\n * - set application.status = payment_pending\r\n * - DO NOT assign installerOrganizationId yet\r\n */\r\nexport async function PATCH(req: Request, ctx: Ctx) {\r\n  try {\r\n    const id = await getIdFromCtx(ctx)\r\n    if (!id) return errorJson(\"Bid session id is required\", 400)\r\n\r\n    const body = await req.json().catch(() => ({}))\r\n    const action = body?.action as \"accept\" | \"reject\" | undefined\r\n    const bidId = body?.bidId as string | undefined\r\n    if (!action || !bidId) return errorJson(\"action and bidId are required\", 400)\r\n\r\n    const session = await prisma.bidSession.findUnique({\r\n      where: { id },\r\n      include: { bids: true, application: true },\r\n    })\r\n    if (!session) return errorJson(\"Bid session not found\", 404)\r\n    if (session.status !== \"open\") return errorJson(\"Bid session is not open\", 400)\r\n\r\n    const target = session.bids.find((b) => b.id === bidId)\r\n    if (!target) return errorJson(\"Bid not found in this session\", 404)\r\n\r\n    const invoiceResult = await prisma.$transaction(async (tx) => {\r\n      if (action === \"reject\") {\r\n        await tx.bid.update({ where: { id: bidId }, data: { status: \"rejected\" } })\r\n        return { invoiceId: null as string | null }\r\n      }\r\n\r\n      // ACCEPT\r\n      await tx.bid.update({ where: { id: bidId }, data: { status: \"accepted\" } })\r\n\r\n      // Reject other pending bids\r\n      const others = session.bids.filter((b) => b.id !== bidId && b.status === \"pending\")\r\n      for (const b of others) {\r\n        await tx.bid.update({ where: { id: b.id }, data: { status: \"rejected\" } })\r\n      }\r\n\r\n      // Close session and remember selected package (field exists in schema)\r\n      await tx.bidSession.update({\r\n        where: { id },\r\n        data: { status: \"closed\", selectedPackageId: target.packageId ?? null },\r\n      })\r\n\r\n      // Create invoice for installation payment\r\n      const invoice = await tx.invoice.create({\r\n        data: {\r\n          applicationId: session.applicationId,\r\n          customerId: session.customerId,\r\n          amount: target.price, // full amount (adjust if you want deposit)\r\n          description: `Installation payment for application ${session.applicationId}`,\r\n          dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\r\n          status: \"pending\",\r\n          type: \"installation\",\r\n        },\r\n      })\r\n\r\n      // Move application to payment_pending; DO NOT assign installer yet\r\n      await tx.application.update({\r\n        where: { id: session.applicationId },\r\n        data: {\r\n          status: \"payment_pending\",\r\n          selectedPackageId: target.packageId ?? null,\r\n          installerOrganizationId: null,\r\n        },\r\n      })\r\n\r\n      return { invoiceId: invoice.id }\r\n    })\r\n\r\n    // Return invoiceId so customer UI can redirect to payment\r\n    return NextResponse.json({ ok: true, invoiceId: invoiceResult.invoiceId }, { status: 200 })\r\n  } catch (e) {\r\n    console.error(\"PATCH /api/bids/[id] error:\", e)\r\n    return NextResponse.json({ error: e instanceof Error ? e.message : \"Failed\" }, { status: 500 })\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}