{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\r\n\r\nconst globalForPrisma = globalThis as unknown as {\r\n  prisma?: PrismaClient\r\n}\r\n\r\nexport const prisma =\r\n  globalForPrisma.prisma ??\r\n  new PrismaClient({\r\n    log:\r\n      process.env.NODE_ENV === \"development\"\r\n        ? [\"error\", \"warn\"]\r\n        : [\"error\"],\r\n  })\r\n\r\nif (process.env.NODE_ENV !== \"production\") {\r\n  globalForPrisma.prisma = prisma\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KACE,uCACI;QAAC;QAAS;KAAO,GACjB;AACR;AAEF,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B"}},
    {"offset": {"line": 72, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/app/api/invoices/%5Bid%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { InvoiceStatus, InvoiceType, BidStatus, ApplicationStatus } from \"@prisma/client\"\r\n\r\nexport const dynamic = \"force-dynamic\"\r\n\r\nexport async function GET(_: NextRequest, context: { params: Promise<{ id: string }> }) {\r\n  const { id } = await context.params\r\n\r\n  const invoice = await prisma.invoice.findUnique({\r\n    where: { id },\r\n    include: { application: { select: { status: true } } },\r\n  })\r\n\r\n  if (!invoice) {\r\n    return NextResponse.json({ error: \"Invoice not found\" }, { status: 404 })\r\n  }\r\n\r\n  const payments: unknown[] = []\r\n  let monthlyBill: {\r\n    month: number\r\n    year: number\r\n    kwhGenerated: number\r\n    kwhExported: number\r\n    kwhImported: number\r\n  } | null = null\r\n\r\n  if (invoice.type === \"monthly_bill\") {\r\n    const month = invoice.dueDate.getMonth() + 1\r\n    const year = invoice.dueDate.getFullYear()\r\n    const reading = await prisma.meterReading.findFirst({\r\n      where: { applicationId: invoice.applicationId, month, year },\r\n    })\r\n    monthlyBill = {\r\n      month,\r\n      year,\r\n      kwhGenerated: reading?.kwhGenerated ?? 0,\r\n      kwhExported: reading?.kwhExported ?? 0,\r\n      kwhImported: reading?.kwhImported ?? 0,\r\n    }\r\n  }\r\n\r\n  return NextResponse.json({\r\n    invoice: { ...invoice, pdfUrl: invoice.pdfUrl ?? `/api/invoices/${invoice.id}/pdf` },\r\n    payments,\r\n    monthlyBill,\r\n  })\r\n}\r\n\r\nexport async function PATCH(req: NextRequest, context: { params: Promise<{ id: string }> }) {\r\n  const { id } = await context.params\r\n\r\n  const invoice = await prisma.invoice.findUnique({\r\n    where: { id },\r\n  })\r\n\r\n  if (!invoice) {\r\n    return NextResponse.json({ error: \"Invoice not found\" }, { status: 404 })\r\n  }\r\n\r\n  const body = await req.json().catch(() => ({}))\r\n  const { status, paidAt } = body as { status?: string; paidAt?: string }\r\n\r\n  const nextStatus: InvoiceStatus =\r\n    status && [\"pending\", \"paid\", \"overdue\"].includes(status)\r\n      ? (status as InvoiceStatus)\r\n      : invoice.status\r\n\r\n  // If caller sets paid status but doesn't provide paidAt, use now\r\n  const nextPaidAt =\r\n    nextStatus === \"paid\"\r\n      ? paidAt\r\n        ? new Date(paidAt)\r\n        : invoice.paidAt ?? new Date()\r\n      : invoice.paidAt\r\n\r\n  try {\r\n    const result = await prisma.$transaction(async (tx) => {\r\n      // 1) Update invoice\r\n      const updatedInvoice = await tx.invoice.update({\r\n        where: { id },\r\n        data: {\r\n          status: nextStatus,\r\n          paidAt: nextPaidAt,\r\n        },\r\n      })\r\n\r\n      // 2) If this is the installation invoice and it just became PAID, release order to installer\r\n      const becamePaid = invoice.status !== \"paid\" && nextStatus === \"paid\"\r\n\r\n      if (becamePaid && invoice.type === InvoiceType.installation) {\r\n        const acceptedBid = await tx.bid.findFirst({\r\n          where: {\r\n            applicationId: invoice.applicationId,\r\n            status: BidStatus.accepted,\r\n          },\r\n        })\r\n\r\n        if (!acceptedBid?.organizationId) {\r\n          throw new Error(\"Accepted bid not found for this application\")\r\n        }\r\n\r\n        await tx.application.update({\r\n          where: { id: invoice.applicationId },\r\n          data: {\r\n            installerOrganizationId: acceptedBid.organizationId,\r\n            selectedPackageId: acceptedBid.packageId ?? null,\r\n            status: ApplicationStatus.agreement_pending,\r\n          },\r\n        })\r\n      }\r\n\r\n      return { invoice: updatedInvoice }\r\n    })\r\n\r\n    return NextResponse.json(result)\r\n  } catch (e) {\r\n    return NextResponse.json(\r\n      { error: e instanceof Error ? e.message : \"Failed to update invoice\" },\r\n      { status: 500 },\r\n    )\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}