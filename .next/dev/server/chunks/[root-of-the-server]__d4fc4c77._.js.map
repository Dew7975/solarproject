{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\r\n\r\nconst globalForPrisma = globalThis as unknown as {\r\n  prisma?: PrismaClient\r\n}\r\n\r\nexport const prisma =\r\n  globalForPrisma.prisma ??\r\n  new PrismaClient({\r\n    log:\r\n      process.env.NODE_ENV === \"development\"\r\n        ? [\"error\", \"warn\"]\r\n        : [\"error\"],\r\n  })\r\n\r\nif (process.env.NODE_ENV !== \"production\") {\r\n  globalForPrisma.prisma = prisma\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KACE,uCACI;QAAC;QAAS;KAAO,GACjB;AACR;AAEF,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/lib/auth-server.ts"],"sourcesContent":["import { cookies } from \"next/headers\"\r\nimport \"server-only\"\r\nimport { NextResponse } from \"next/server\"\r\nimport { randomUUID } from \"crypto\"\r\nimport { SignJWT, jwtVerify } from \"jose\"\r\nimport bcrypt from \"bcryptjs\"\r\nimport { prisma } from \"./prisma\"\r\nimport { UserRole } from \"@prisma/client\"\r\n\r\nconst SESSION_COOKIE = \"session_token\"\r\nconst SESSION_DURATION_MS = 1000 * 60 * 60 * 24 * 7\r\n\r\nfunction getSecret() {\r\n  const secret = process.env.JWT_SECRET\r\n  if (!secret) {\r\n    throw new Error(\"Missing JWT_SECRET\")\r\n  }\r\n  return new TextEncoder().encode(secret)\r\n}\r\n\r\nexport async function hashPassword(password: string) {\r\n  return bcrypt.hash(password, 10)\r\n}\r\n\r\nexport async function verifyPassword(password: string, hash: string) {\r\n  return bcrypt.compare(password, hash)\r\n}\r\n\r\nexport async function createAuthSession(userId: string, role: UserRole) {\r\n  const token = randomUUID()\r\n  const expiresAt = new Date(Date.now() + SESSION_DURATION_MS)\r\n\r\n  await prisma.session.create({\r\n    data: {\r\n      token,\r\n      userId,\r\n      expiresAt,\r\n    },\r\n  })\r\n\r\n  const jwt = await new SignJWT({ token, role })\r\n    .setProtectedHeader({ alg: \"HS256\" })\r\n    .setExpirationTime(expiresAt)\r\n    .sign(getSecret())\r\n\r\n  const cookieStore = await cookies()\r\n  cookieStore.set(SESSION_COOKIE, jwt, {\r\n    httpOnly: true,\r\n    sameSite: \"lax\",\r\n    expires: expiresAt,\r\n    path: \"/\",\r\n    secure: process.env.NODE_ENV === \"production\",\r\n  })\r\n  return token\r\n}\r\n\r\nexport async function clearSession() {\r\n  const cookieStore = await cookies()\r\n  const token = cookieStore.get(SESSION_COOKIE)?.value\r\n  if (token) {\r\n    await prisma.session.deleteMany({ where: { token } })\r\n  }\r\n  cookieStore.delete(SESSION_COOKIE)\r\n}\r\n\r\nexport async function getSessionUser() {\r\n  const cookieStore = await cookies()\r\n  const jwt = cookieStore.get(SESSION_COOKIE)?.value\r\n  if (!jwt) return null\r\n\r\n  try {\r\n    const { payload } = await jwtVerify(jwt, getSecret())\r\n    const token = payload.token as string\r\n    if (!token) return null\r\n    const session = await prisma.session.findUnique({\r\n      where: { token },\r\n      include: {\r\n        user: {\r\n          include: { organization: { select: { id: true, name: true, isRejected: true } } },\r\n        },\r\n      },\r\n    })\r\n    if (!session || session.expiresAt < new Date()) {\r\n      return null\r\n    }\r\n    if (session.user.status === \"suspended\") {\r\n      await prisma.session.deleteMany({ where: { token } })\r\n      cookieStore.delete(SESSION_COOKIE)\r\n      return null\r\n    }\r\n    return session.user\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\nexport function requireRole(userRole: UserRole, allowed: UserRole[]) {\r\n  if (!allowed.includes(userRole)) {\r\n    return NextResponse.json({ error: \"Forbidden\" }, { status: 403 })\r\n  }\r\n  return null\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;;;;;;;;AAGA,MAAM,iBAAiB;AACvB,MAAM,sBAAsB,OAAO,KAAK,KAAK,KAAK;AAElD,SAAS;IACP,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU;IACrC,IAAI,CAAC,QAAQ;QACX,MAAM,IAAI,MAAM;IAClB;IACA,OAAO,IAAI,cAAc,MAAM,CAAC;AAClC;AAEO,eAAe,aAAa,QAAgB;IACjD,OAAO,+KAAM,CAAC,IAAI,CAAC,UAAU;AAC/B;AAEO,eAAe,eAAe,QAAgB,EAAE,IAAY;IACjE,OAAO,+KAAM,CAAC,OAAO,CAAC,UAAU;AAClC;AAEO,eAAe,kBAAkB,MAAc,EAAE,IAAc;IACpE,MAAM,QAAQ,IAAA,mHAAU;IACxB,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK;IAExC,MAAM,0JAAM,CAAC,OAAO,CAAC,MAAM,CAAC;QAC1B,MAAM;YACJ;YACA;YACA;QACF;IACF;IAEA,MAAM,MAAM,MAAM,IAAI,wMAAO,CAAC;QAAE;QAAO;IAAK,GACzC,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,iBAAiB,CAAC,WAClB,IAAI,CAAC;IAER,MAAM,cAAc,MAAM,IAAA,6KAAO;IACjC,YAAY,GAAG,CAAC,gBAAgB,KAAK;QACnC,UAAU;QACV,UAAU;QACV,SAAS;QACT,MAAM;QACN,QAAQ,oDAAyB;IACnC;IACA,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,6KAAO;IACjC,MAAM,QAAQ,YAAY,GAAG,CAAC,iBAAiB;IAC/C,IAAI,OAAO;QACT,MAAM,0JAAM,CAAC,OAAO,CAAC,UAAU,CAAC;YAAE,OAAO;gBAAE;YAAM;QAAE;IACrD;IACA,YAAY,MAAM,CAAC;AACrB;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,6KAAO;IACjC,MAAM,MAAM,YAAY,GAAG,CAAC,iBAAiB;IAC7C,IAAI,CAAC,KAAK,OAAO;IAEjB,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,4MAAS,EAAC,KAAK;QACzC,MAAM,QAAQ,QAAQ,KAAK;QAC3B,IAAI,CAAC,OAAO,OAAO;QACnB,MAAM,UAAU,MAAM,0JAAM,CAAC,OAAO,CAAC,UAAU,CAAC;YAC9C,OAAO;gBAAE;YAAM;YACf,SAAS;gBACP,MAAM;oBACJ,SAAS;wBAAE,cAAc;4BAAE,QAAQ;gCAAE,IAAI;gCAAM,MAAM;gCAAM,YAAY;4BAAK;wBAAE;oBAAE;gBAClF;YACF;QACF;QACA,IAAI,CAAC,WAAW,QAAQ,SAAS,GAAG,IAAI,QAAQ;YAC9C,OAAO;QACT;QACA,IAAI,QAAQ,IAAI,CAAC,MAAM,KAAK,aAAa;YACvC,MAAM,0JAAM,CAAC,OAAO,CAAC,UAAU,CAAC;gBAAE,OAAO;oBAAE;gBAAM;YAAE;YACnD,YAAY,MAAM,CAAC;YACnB,OAAO;QACT;QACA,OAAO,QAAQ,IAAI;IACrB,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,SAAS,YAAY,QAAkB,EAAE,OAAmB;IACjE,IAAI,CAAC,QAAQ,QAAQ,CAAC,WAAW;QAC/B,OAAO,iLAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;IACjE;IACA,OAAO;AACT"}},
    {"offset": {"line": 247, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/app/api/profile/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\nimport { randomUUID } from \"crypto\"\r\nimport { promises as fs } from \"fs\"\r\nimport path from \"path\"\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { getSessionUser, hashPassword, verifyPassword } from \"@/lib/auth-server\"\r\n\r\nconst uploadsDir = path.join(process.cwd(), \"public\", \"uploads\")\r\n\r\nasync function persistAvatar(file: File) {\r\n  await fs.mkdir(uploadsDir, { recursive: true })\r\n  const arrayBuffer = await file.arrayBuffer()\r\n  const ext = path.extname(file.name || \"\") || \".png\"\r\n  const storedName = `${randomUUID()}${ext}`\r\n  const storedPath = path.join(uploadsDir, storedName)\r\n  await fs.writeFile(storedPath, Buffer.from(arrayBuffer))\r\n  return `/uploads/${storedName}`\r\n}\r\n\r\nexport async function GET() {\r\n  const user = await getSessionUser()\r\n  if (!user) {\r\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\r\n  }\r\n\r\n  return NextResponse.json({\r\n    user: {\r\n      id: user.id,\r\n      name: user.name,\r\n      email: user.email,\r\n      phone: user.phone,\r\n      address: user.address,\r\n      profileImageUrl: user.profileImageUrl ?? null,\r\n      role: user.role,\r\n    },\r\n  })\r\n}\r\n\r\nexport async function PATCH(req: NextRequest) {\r\n  const user = await getSessionUser()\r\n  if (!user) {\r\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\r\n  }\r\n\r\n  const contentType = req.headers.get(\"content-type\") || \"\"\r\n  let name: string | undefined\r\n  let email: string | undefined\r\n  let phone: string | undefined\r\n  let address: string | undefined\r\n  let currentPassword: string | undefined\r\n  let newPassword: string | undefined\r\n  let profileImageUrl: string | undefined\r\n\r\n  if (contentType.includes(\"multipart/form-data\")) {\r\n    const formData = await req.formData()\r\n    name = (formData.get(\"name\") as string | null) ?? undefined\r\n    email = (formData.get(\"email\") as string | null) ?? undefined\r\n    phone = (formData.get(\"phone\") as string | null) ?? undefined\r\n    address = (formData.get(\"address\") as string | null) ?? undefined\r\n    currentPassword = (formData.get(\"currentPassword\") as string | null) ?? undefined\r\n    newPassword = (formData.get(\"newPassword\") as string | null) ?? undefined\r\n    const avatar = formData.get(\"avatar\")\r\n    if (avatar && typeof avatar !== \"string\") {\r\n      profileImageUrl = await persistAvatar(avatar)\r\n    }\r\n  } else {\r\n    const body = await req.json().catch(() => null)\r\n    if (!body) {\r\n      return NextResponse.json({ error: \"Invalid payload\" }, { status: 400 })\r\n    }\r\n    name = body.name\r\n    email = body.email\r\n    phone = body.phone\r\n    address = body.address\r\n    currentPassword = body.currentPassword\r\n    newPassword = body.newPassword\r\n  }\r\n\r\n  if (email && email !== user.email) {\r\n    const existing = await prisma.user.findUnique({ where: { email } })\r\n    if (existing && existing.id !== user.id) {\r\n      return NextResponse.json({ error: \"Email already in use\" }, { status: 409 })\r\n    }\r\n  }\r\n\r\n  if (newPassword) {\r\n    if (!currentPassword) {\r\n      return NextResponse.json({ error: \"Current password is required\" }, { status: 400 })\r\n    }\r\n    const valid = await verifyPassword(currentPassword, user.passwordHash)\r\n    if (!valid) {\r\n      return NextResponse.json({ error: \"Current password is incorrect\" }, { status: 400 })\r\n    }\r\n  }\r\n\r\n  const data: Record<string, unknown> = {\r\n    name: name ?? user.name,\r\n    email: email ?? user.email,\r\n    phone: phone ?? user.phone,\r\n    address: address ?? user.address,\r\n  }\r\n\r\n  if (profileImageUrl) {\r\n    data.profileImageUrl = profileImageUrl\r\n  }\r\n\r\n  if (newPassword) {\r\n    data.passwordHash = await hashPassword(newPassword)\r\n  }\r\n\r\n  const updated = await prisma.user.update({\r\n    where: { id: user.id },\r\n    data,\r\n  })\r\n\r\n  return NextResponse.json({\r\n    user: {\r\n      id: updated.id,\r\n      name: updated.name,\r\n      email: updated.email,\r\n      phone: updated.phone,\r\n      address: updated.address,\r\n      profileImageUrl: updated.profileImageUrl ?? null,\r\n      role: updated.role,\r\n    },\r\n  })\r\n}\r\n"],"names":[],"mappings":"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"}}]
}