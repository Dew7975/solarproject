{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\r\n\r\nconst globalForPrisma = globalThis as unknown as {\r\n  prisma?: PrismaClient\r\n}\r\n\r\nexport const prisma =\r\n  globalForPrisma.prisma ??\r\n  new PrismaClient({\r\n    log:\r\n      process.env.NODE_ENV === \"development\"\r\n        ? [\"error\", \"warn\"]\r\n        : [\"error\"],\r\n  })\r\n\r\nif (process.env.NODE_ENV !== \"production\") {\r\n  globalForPrisma.prisma = prisma\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KACE,uCACI;QAAC;QAAS;KAAO,GACjB;AACR;AAEF,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B"}},
    {"offset": {"line": 96, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/lib/auth-server.ts"],"sourcesContent":["import { cookies } from \"next/headers\"\r\nimport \"server-only\"\r\nimport { NextResponse } from \"next/server\"\r\nimport { randomUUID } from \"crypto\"\r\nimport { SignJWT, jwtVerify } from \"jose\"\r\nimport bcrypt from \"bcryptjs\"\r\nimport { prisma } from \"./prisma\"\r\nimport { UserRole } from \"@prisma/client\"\r\n\r\nconst SESSION_COOKIE = \"session_token\"\r\nconst SESSION_DURATION_MS = 1000 * 60 * 60 * 24 * 7\r\n\r\nfunction getSecret() {\r\n  const secret = process.env.JWT_SECRET\r\n  if (!secret) {\r\n    throw new Error(\"Missing JWT_SECRET\")\r\n  }\r\n  return new TextEncoder().encode(secret)\r\n}\r\n\r\nexport async function hashPassword(password: string) {\r\n  return bcrypt.hash(password, 10)\r\n}\r\n\r\nexport async function verifyPassword(password: string, hash: string) {\r\n  return bcrypt.compare(password, hash)\r\n}\r\n\r\nexport async function createAuthSession(userId: string, role: UserRole) {\r\n  const token = randomUUID()\r\n  const expiresAt = new Date(Date.now() + SESSION_DURATION_MS)\r\n\r\n  await prisma.session.create({\r\n    data: {\r\n      token,\r\n      userId,\r\n      expiresAt,\r\n    },\r\n  })\r\n\r\n  const jwt = await new SignJWT({ token, role })\r\n    .setProtectedHeader({ alg: \"HS256\" })\r\n    .setExpirationTime(expiresAt)\r\n    .sign(getSecret())\r\n\r\n  const cookieStore = await cookies()\r\n  cookieStore.set(SESSION_COOKIE, jwt, {\r\n    httpOnly: true,\r\n    sameSite: \"lax\",\r\n    expires: expiresAt,\r\n    path: \"/\",\r\n    secure: process.env.NODE_ENV === \"production\",\r\n  })\r\n  return token\r\n}\r\n\r\nexport async function clearSession() {\r\n  const cookieStore = await cookies()\r\n  const token = cookieStore.get(SESSION_COOKIE)?.value\r\n  if (token) {\r\n    await prisma.session.deleteMany({ where: { token } })\r\n  }\r\n  cookieStore.delete(SESSION_COOKIE)\r\n}\r\n\r\nexport async function getSessionUser() {\r\n  const cookieStore = await cookies()\r\n  const jwt = cookieStore.get(SESSION_COOKIE)?.value\r\n  if (!jwt) return null\r\n\r\n  try {\r\n    const { payload } = await jwtVerify(jwt, getSecret())\r\n    const token = payload.token as string\r\n    if (!token) return null\r\n    const session = await prisma.session.findUnique({\r\n      where: { token },\r\n      include: {\r\n        user: {\r\n          include: { organization: { select: { id: true, name: true, isRejected: true } } },\r\n        },\r\n      },\r\n    })\r\n    if (!session || session.expiresAt < new Date()) {\r\n      return null\r\n    }\r\n    if (session.user.status === \"suspended\") {\r\n      await prisma.session.deleteMany({ where: { token } })\r\n      cookieStore.delete(SESSION_COOKIE)\r\n      return null\r\n    }\r\n    return session.user\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\nexport function requireRole(userRole: UserRole, allowed: UserRole[]) {\r\n  if (!allowed.includes(userRole)) {\r\n    return NextResponse.json({ error: \"Forbidden\" }, { status: 403 })\r\n  }\r\n  return null\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;;;;;;;;AAGA,MAAM,iBAAiB;AACvB,MAAM,sBAAsB,OAAO,KAAK,KAAK,KAAK;AAElD,SAAS;IACP,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU;IACrC,IAAI,CAAC,QAAQ;QACX,MAAM,IAAI,MAAM;IAClB;IACA,OAAO,IAAI,cAAc,MAAM,CAAC;AAClC;AAEO,eAAe,aAAa,QAAgB;IACjD,OAAO,+KAAM,CAAC,IAAI,CAAC,UAAU;AAC/B;AAEO,eAAe,eAAe,QAAgB,EAAE,IAAY;IACjE,OAAO,+KAAM,CAAC,OAAO,CAAC,UAAU;AAClC;AAEO,eAAe,kBAAkB,MAAc,EAAE,IAAc;IACpE,MAAM,QAAQ,IAAA,mHAAU;IACxB,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK;IAExC,MAAM,0JAAM,CAAC,OAAO,CAAC,MAAM,CAAC;QAC1B,MAAM;YACJ;YACA;YACA;QACF;IACF;IAEA,MAAM,MAAM,MAAM,IAAI,wMAAO,CAAC;QAAE;QAAO;IAAK,GACzC,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,iBAAiB,CAAC,WAClB,IAAI,CAAC;IAER,MAAM,cAAc,MAAM,IAAA,6KAAO;IACjC,YAAY,GAAG,CAAC,gBAAgB,KAAK;QACnC,UAAU;QACV,UAAU;QACV,SAAS;QACT,MAAM;QACN,QAAQ,oDAAyB;IACnC;IACA,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,6KAAO;IACjC,MAAM,QAAQ,YAAY,GAAG,CAAC,iBAAiB;IAC/C,IAAI,OAAO;QACT,MAAM,0JAAM,CAAC,OAAO,CAAC,UAAU,CAAC;YAAE,OAAO;gBAAE;YAAM;QAAE;IACrD;IACA,YAAY,MAAM,CAAC;AACrB;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,6KAAO;IACjC,MAAM,MAAM,YAAY,GAAG,CAAC,iBAAiB;IAC7C,IAAI,CAAC,KAAK,OAAO;IAEjB,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,4MAAS,EAAC,KAAK;QACzC,MAAM,QAAQ,QAAQ,KAAK;QAC3B,IAAI,CAAC,OAAO,OAAO;QACnB,MAAM,UAAU,MAAM,0JAAM,CAAC,OAAO,CAAC,UAAU,CAAC;YAC9C,OAAO;gBAAE;YAAM;YACf,SAAS;gBACP,MAAM;oBACJ,SAAS;wBAAE,cAAc;4BAAE,QAAQ;gCAAE,IAAI;gCAAM,MAAM;gCAAM,YAAY;4BAAK;wBAAE;oBAAE;gBAClF;YACF;QACF;QACA,IAAI,CAAC,WAAW,QAAQ,SAAS,GAAG,IAAI,QAAQ;YAC9C,OAAO;QACT;QACA,IAAI,QAAQ,IAAI,CAAC,MAAM,KAAK,aAAa;YACvC,MAAM,0JAAM,CAAC,OAAO,CAAC,UAAU,CAAC;gBAAE,OAAO;oBAAE;gBAAM;YAAE;YACnD,YAAY,MAAM,CAAC;YACnB,OAAO;QACT;QACA,OAAO,QAAQ,IAAI;IACrB,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,SAAS,YAAY,QAAkB,EAAE,OAAmB;IACjE,IAAI,CAAC,QAAQ,QAAQ,CAAC,WAAW;QAC/B,OAAO,iLAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;IACjE;IACA,OAAO;AACT"}},
    {"offset": {"line": 235, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/lib/billing.ts"],"sourcesContent":["import { prisma } from \"./prisma\"\r\nimport { Invoice, MeterReading, MonthlyBill } from \"./prisma-types\"\r\n\r\ninterface MonthlyBillInput {\r\n  month: number\r\n  year: number\r\n  ratePerKwh?: number\r\n  creditRatePerKwh?: number\r\n}\r\n\r\nexport function getMeteringRates() {\r\n  const ratePerKwh = Number(process.env.NET_METER_RATE_PER_KWH ?? \"30\")\r\n  const creditRatePerKwh = Number(process.env.NET_METER_CREDIT_RATE_PER_KWH ?? \"25\")\r\n  return { ratePerKwh, creditRatePerKwh }\r\n}\r\n\r\nexport function computeMonthlyAmount(\r\n  netUnits: number,\r\n  ratePerKwh: number,\r\n  creditRatePerKwh: number,\r\n) {\r\n  if (netUnits >= 0) {\r\n    return netUnits * ratePerKwh\r\n  }\r\n  return netUnits * creditRatePerKwh\r\n}\r\n\r\nexport async function generateMonthlyBills(input: MonthlyBillInput) {\r\n  const { month, year, ratePerKwh = 30, creditRatePerKwh = 25 } = input\r\n  const readings = await prisma.meterReading.findMany({\r\n    where: { month, year },\r\n    include: { application: true },\r\n  })\r\n  const created: { bill: MonthlyBill; invoice: Invoice }[] = []\r\n\r\n  for (const reading of readings) {\r\n    const netUnits = reading.kwhImported - reading.kwhExported\r\n    const amount = computeMonthlyAmount(netUnits, ratePerKwh, creditRatePerKwh)\r\n    const dueDate = new Date(year, month - 1, 1)\r\n    dueDate.setDate(dueDate.getDate() + 14)\r\n\r\n    const invoice = await prisma.invoice.create({\r\n      data: {\r\n        applicationId: reading.applicationId ?? null,\r\n        customerId: reading.application.customerId,\r\n        type: \"monthly_bill\",\r\n        description: `${dueDate.toLocaleString(\"default\", { month: \"long\" })} Net Metering Bill`,\r\n        amount,\r\n        status: \"pending\",\r\n        dueDate,\r\n        paidAt: null,\r\n      },\r\n    })\r\n\r\n    const bill: MonthlyBill = {\r\n      id: `MB-${reading.id}`,\r\n      invoiceId: invoice.id,\r\n      customerId: reading.application.customerId,\r\n      applicationId: reading.applicationId ?? null,\r\n      month,\r\n      year,\r\n      kwhGenerated: reading.kwhGenerated,\r\n      kwhExported: reading.kwhExported,\r\n      kwhImported: reading.kwhImported,\r\n      netAmount: amount,\r\n      amount,\r\n      status: \"pending\",\r\n      createdAt: invoice.createdAt.toISOString(),\r\n    }\r\n\r\n    created.push({\r\n      bill,\r\n      invoice: {\r\n        id: invoice.id,\r\n        applicationId: invoice.applicationId,\r\n        customerId: invoice.customerId,\r\n        type: invoice.type,\r\n        description: invoice.description,\r\n        amount: invoice.amount,\r\n        status: invoice.status,\r\n        dueDate: invoice.dueDate.toISOString(),\r\n        paidAt: invoice.paidAt?.toISOString() ?? null,\r\n        createdAt: invoice.createdAt.toISOString(),\r\n        updatedAt: invoice.updatedAt.toISOString(),\r\n      },\r\n    })\r\n  }\r\n\r\n  return created\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAUO,SAAS;IACd,MAAM,aAAa,OAAO,QAAQ,GAAG,CAAC,sBAAsB,IAAI;IAChE,MAAM,mBAAmB,OAAO,QAAQ,GAAG,CAAC,6BAA6B,IAAI;IAC7E,OAAO;QAAE;QAAY;IAAiB;AACxC;AAEO,SAAS,qBACd,QAAgB,EAChB,UAAkB,EAClB,gBAAwB;IAExB,IAAI,YAAY,GAAG;QACjB,OAAO,WAAW;IACpB;IACA,OAAO,WAAW;AACpB;AAEO,eAAe,qBAAqB,KAAuB;IAChE,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,aAAa,EAAE,EAAE,mBAAmB,EAAE,EAAE,GAAG;IAChE,MAAM,WAAW,MAAM,0JAAM,CAAC,YAAY,CAAC,QAAQ,CAAC;QAClD,OAAO;YAAE;YAAO;QAAK;QACrB,SAAS;YAAE,aAAa;QAAK;IAC/B;IACA,MAAM,UAAqD,EAAE;IAE7D,KAAK,MAAM,WAAW,SAAU;QAC9B,MAAM,WAAW,QAAQ,WAAW,GAAG,QAAQ,WAAW;QAC1D,MAAM,SAAS,qBAAqB,UAAU,YAAY;QAC1D,MAAM,UAAU,IAAI,KAAK,MAAM,QAAQ,GAAG;QAC1C,QAAQ,OAAO,CAAC,QAAQ,OAAO,KAAK;QAEpC,MAAM,UAAU,MAAM,0JAAM,CAAC,OAAO,CAAC,MAAM,CAAC;YAC1C,MAAM;gBACJ,eAAe,QAAQ,aAAa,IAAI;gBACxC,YAAY,QAAQ,WAAW,CAAC,UAAU;gBAC1C,MAAM;gBACN,aAAa,GAAG,QAAQ,cAAc,CAAC,WAAW;oBAAE,OAAO;gBAAO,GAAG,kBAAkB,CAAC;gBACxF;gBACA,QAAQ;gBACR;gBACA,QAAQ;YACV;QACF;QAEA,MAAM,OAAoB;YACxB,IAAI,CAAC,GAAG,EAAE,QAAQ,EAAE,EAAE;YACtB,WAAW,QAAQ,EAAE;YACrB,YAAY,QAAQ,WAAW,CAAC,UAAU;YAC1C,eAAe,QAAQ,aAAa,IAAI;YACxC;YACA;YACA,cAAc,QAAQ,YAAY;YAClC,aAAa,QAAQ,WAAW;YAChC,aAAa,QAAQ,WAAW;YAChC,WAAW;YACX;YACA,QAAQ;YACR,WAAW,QAAQ,SAAS,CAAC,WAAW;QAC1C;QAEA,QAAQ,IAAI,CAAC;YACX;YACA,SAAS;gBACP,IAAI,QAAQ,EAAE;gBACd,eAAe,QAAQ,aAAa;gBACpC,YAAY,QAAQ,UAAU;gBAC9B,MAAM,QAAQ,IAAI;gBAClB,aAAa,QAAQ,WAAW;gBAChC,QAAQ,QAAQ,MAAM;gBACtB,QAAQ,QAAQ,MAAM;gBACtB,SAAS,QAAQ,OAAO,CAAC,WAAW;gBACpC,QAAQ,QAAQ,MAAM,EAAE,iBAAiB;gBACzC,WAAW,QAAQ,SAAS,CAAC,WAAW;gBACxC,WAAW,QAAQ,SAAS,CAAC,WAAW;YAC1C;QACF;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 328, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/lib/pdf.ts"],"sourcesContent":["function escapePdfText(value: string) {\r\n  return value.replace(/\\\\/g, \"\\\\\\\\\").replace(/\\(/g, \"\\\\(\").replace(/\\)/g, \"\\\\)\")\r\n}\r\n\r\ntype PdfSection = {\r\n  title: string\r\n  lines: { label: string; value: string }[]\r\n}\r\n\r\nexport function buildSimplePdf(title: string, lines: string[]) {\r\n  const contentLines = [\r\n    \"BT\",\r\n    \"/F1 18 Tf\",\r\n    \"72 740 Td\",\r\n    `(${escapePdfText(title)}) Tj`,\r\n    \"/F1 12 Tf\",\r\n    \"16 TL\",\r\n    ...lines.map((line) => `T* (${escapePdfText(line)}) Tj`),\r\n    \"ET\",\r\n  ].join(\"\\n\")\r\n\r\n  const objects: string[] = []\r\n  objects[1] = \"1 0 obj\\n<< /Type /Catalog /Pages 2 0 R >>\\nendobj\\n\"\r\n  objects[2] = \"2 0 obj\\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\\nendobj\\n\"\r\n  objects[3] =\r\n    \"3 0 obj\\n<< /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Contents 4 0 R /Resources << /Font << /F1 5 0 R >> >> >>\\nendobj\\n\"\r\n  objects[4] =\r\n    `4 0 obj\\n<< /Length ${Buffer.byteLength(contentLines, \"utf8\")} >>\\nstream\\n${contentLines}\\nendstream\\nendobj\\n`\r\n  objects[5] =\r\n    \"5 0 obj\\n<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>\\nendobj\\n\"\r\n\r\n  let pdf = \"%PDF-1.4\\n\"\r\n  const offsets: number[] = [0]\r\n  for (let i = 1; i <= 5; i += 1) {\r\n    offsets[i] = pdf.length\r\n    pdf += objects[i]\r\n  }\r\n  const xrefStart = pdf.length\r\n  pdf += \"xref\\n0 6\\n0000000000 65535 f \\n\"\r\n  for (let i = 1; i <= 5; i += 1) {\r\n    pdf += `${String(offsets[i]).padStart(10, \"0\")} 00000 n \\n`\r\n  }\r\n  pdf += \"trailer\\n<< /Size 6 /Root 1 0 R >>\\nstartxref\\n\"\r\n  pdf += `${xrefStart}\\n%%EOF\\n`\r\n  return Buffer.from(pdf, \"utf8\")\r\n}\r\n\r\nexport function buildReportPdf({\r\n  title,\r\n  subtitle,\r\n  sections,\r\n  footer,\r\n}: {\r\n  title: string\r\n  subtitle?: string\r\n  sections: PdfSection[]\r\n  footer?: string\r\n}) {\r\n  const content: string[] = []\r\n\r\n  // Header background\r\n  content.push(\"0.93 0.97 0.99 rg\")\r\n  content.push(\"0 720 612 72 re f\")\r\n\r\n  // Title\r\n  content.push(\"0 0 0 rg\")\r\n  content.push(\"BT\")\r\n  content.push(\"/F1 18 Tf\")\r\n  content.push(\"72 760 Td\")\r\n  content.push(`(${escapePdfText(title)}) Tj`)\r\n  if (subtitle) {\r\n    content.push(\"/F1 10 Tf\")\r\n    content.push(\"0 -18 Td\")\r\n    content.push(`(${escapePdfText(subtitle)}) Tj`)\r\n  }\r\n  content.push(\"ET\")\r\n\r\n  let y = 680\r\n  sections.forEach((section) => {\r\n    content.push(\"BT\")\r\n    content.push(\"/F1 12 Tf\")\r\n    content.push(`72 ${y} Td`)\r\n    content.push(`(${escapePdfText(section.title)}) Tj`)\r\n    content.push(\"ET\")\r\n    y -= 16\r\n\r\n    section.lines.forEach((line) => {\r\n      content.push(\"BT\")\r\n      content.push(\"/F1 10 Tf\")\r\n      content.push(`72 ${y} Td`)\r\n      content.push(`(${escapePdfText(line.label)}) Tj`)\r\n      content.push(\"ET\")\r\n      content.push(\"BT\")\r\n      content.push(\"/F1 10 Tf\")\r\n      content.push(`360 ${y} Td`)\r\n      content.push(`(${escapePdfText(line.value)}) Tj`)\r\n      content.push(\"ET\")\r\n      y -= 14\r\n    })\r\n\r\n    y -= 10\r\n    content.push(\"0.85 0.85 0.85 RG\")\r\n    content.push(`72 ${y} m 540 ${y} l S`)\r\n    y -= 14\r\n  })\r\n\r\n  if (footer) {\r\n    content.push(\"0 0 0 rg\")\r\n    content.push(\"BT\")\r\n    content.push(\"/F1 9 Tf\")\r\n    content.push(`72 ${y} Td`)\r\n    content.push(`(${escapePdfText(footer)}) Tj`)\r\n    content.push(\"ET\")\r\n  }\r\n\r\n  const contentLines = content.join(\"\\n\")\r\n\r\n  const objects: string[] = []\r\n  objects[1] = \"1 0 obj\\n<< /Type /Catalog /Pages 2 0 R >>\\nendobj\\n\"\r\n  objects[2] = \"2 0 obj\\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\\nendobj\\n\"\r\n  objects[3] =\r\n    \"3 0 obj\\n<< /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Contents 4 0 R /Resources << /Font << /F1 5 0 R >> >> >>\\nendobj\\n\"\r\n  objects[4] =\r\n    `4 0 obj\\n<< /Length ${Buffer.byteLength(contentLines, \"utf8\")} >>\\nstream\\n${contentLines}\\nendstream\\nendobj\\n`\r\n  objects[5] =\r\n    \"5 0 obj\\n<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>\\nendobj\\n\"\r\n\r\n  let pdf = \"%PDF-1.4\\n\"\r\n  const offsets: number[] = [0]\r\n  for (let i = 1; i <= 5; i += 1) {\r\n    offsets[i] = pdf.length\r\n    pdf += objects[i]\r\n  }\r\n  const xrefStart = pdf.length\r\n  pdf += \"xref\\n0 6\\n0000000000 65535 f \\n\"\r\n  for (let i = 1; i <= 5; i += 1) {\r\n    pdf += `${String(offsets[i]).padStart(10, \"0\")} 00000 n \\n`\r\n  }\r\n  pdf += \"trailer\\n<< /Size 6 /Root 1 0 R >>\\nstartxref\\n\"\r\n  pdf += `${xrefStart}\\n%%EOF\\n`\r\n  return Buffer.from(pdf, \"utf8\")\r\n}\r\n\r\nexport async function writePdfToPublic({\r\n  filename,\r\n  buffer,\r\n}: {\r\n  filename: string\r\n  buffer: Buffer\r\n}) {\r\n  const { promises: fs } = await import(\"fs\")\r\n  const path = await import(\"path\")\r\n  const dir = path.join(process.cwd(), \"public\", \"pdfs\")\r\n  await fs.mkdir(dir, { recursive: true })\r\n  const filePath = path.join(dir, filename)\r\n  await fs.writeFile(filePath, buffer)\r\n  return `/pdfs/${filename}`\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 463, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/app/api/meter-readings/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\nimport { UserRole } from \"@prisma/client\"\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { getSessionUser, requireRole } from \"@/lib/auth-server\"\r\nimport { computeMonthlyAmount, getMeteringRates } from \"@/lib/billing\"\r\nimport { buildReportPdf, writePdfToPublic } from \"@/lib/pdf\"\r\n\r\nexport const dynamic = \"force-dynamic\"\r\n\r\n/* ------------------------------------------------------------------ */\r\n/* GET /api/meter-readings                                             */\r\n/* ------------------------------------------------------------------ */\r\n\r\nexport async function GET() {\r\n  const user = await getSessionUser()\r\n  if (!user) {\r\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\r\n  }\r\n\r\n  if (user.role === UserRole.customer) {\r\n    const readings = await prisma.meterReading.findMany({\r\n      where: { application: { customerId: user.id } },\r\n      orderBy: [{ year: \"desc\" }, { month: \"desc\" }],\r\n    })\r\n    return NextResponse.json({ readings })\r\n  }\r\n\r\n  if (user.role === UserRole.installer) {\r\n    const readings = await prisma.meterReading.findMany({\r\n      where: user.organizationId\r\n        ? { application: { installerOrganizationId: user.organizationId } }\r\n        : { applicationId: \"__none__\" },\r\n      orderBy: [{ year: \"desc\" }, { month: \"desc\" }],\r\n    })\r\n    return NextResponse.json({ readings })\r\n  }\r\n\r\n  const forbidden = requireRole(user.role, [UserRole.officer])\r\n  if (forbidden) return forbidden\r\n\r\n  const readings = await prisma.meterReading.findMany({\r\n    orderBy: [{ year: \"desc\" }, { month: \"desc\" }],\r\n  })\r\n\r\n  return NextResponse.json({ readings })\r\n}\r\n\r\n/* ------------------------------------------------------------------ */\r\n/* POST /api/meter-readings                                            */\r\n/* ------------------------------------------------------------------ */\r\n\r\nexport async function POST(req: NextRequest) {\r\n  const user = await getSessionUser()\r\n  if (!user) {\r\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\r\n  }\r\n\r\n  const forbidden = requireRole(user.role, [UserRole.officer])\r\n  if (forbidden) return forbidden\r\n\r\n  const body = await req.json()\r\n  const {\r\n    applicationId,\r\n    readingDate,\r\n    month,\r\n    year,\r\n    kwhGenerated,\r\n    kwhExported,\r\n    kwhImported,\r\n  } = body as {\r\n    applicationId?: string\r\n    readingDate?: string\r\n    month?: number\r\n    year?: number\r\n    kwhGenerated?: number\r\n    kwhExported?: number\r\n    kwhImported?: number\r\n  }\r\n\r\n  if (\r\n    !applicationId ||\r\n    (!readingDate && (!month || !year)) ||\r\n    kwhGenerated === undefined ||\r\n    kwhExported === undefined ||\r\n    kwhImported === undefined\r\n  ) {\r\n    return NextResponse.json(\r\n      {\r\n        error:\r\n          \"applicationId, readingDate or month/year, kwhGenerated, kwhExported, and kwhImported are required\",\r\n      },\r\n      { status: 400 },\r\n    )\r\n  }\r\n\r\n  const effectiveDate = readingDate ? new Date(readingDate) : new Date(Number(year), Number(month) - 1, 1)\r\n\r\n  const application = await prisma.application.findUnique({\r\n    where: { id: applicationId },\r\n  })\r\n\r\n  if (!application) {\r\n    return NextResponse.json({ error: \"Application not found\" }, { status: 404 })\r\n  }\r\n\r\n  const existingReading = await prisma.meterReading.findFirst({\r\n    where: {\r\n      applicationId,\r\n      month: effectiveDate.getMonth() + 1,\r\n      year: effectiveDate.getFullYear(),\r\n    },\r\n  })\r\n\r\n  if (existingReading) {\r\n    return NextResponse.json(\r\n      { error: \"Meter reading already submitted for this month.\" },\r\n      { status: 409 },\r\n    )\r\n  }\r\n\r\n  const reading = await prisma.meterReading.create({\r\n    data: {\r\n      applicationId,\r\n      userId: user.id,\r\n      month: effectiveDate.getMonth() + 1,\r\n      year: effectiveDate.getFullYear(),\r\n      kwhGenerated,\r\n      kwhExported,\r\n      kwhImported,\r\n    },\r\n  })\r\n\r\n  const { ratePerKwh, creditRatePerKwh } = getMeteringRates()\r\n  const netUnits = reading.kwhImported - reading.kwhExported\r\n  const amount = computeMonthlyAmount(netUnits, ratePerKwh, creditRatePerKwh)\r\n  const dueDate = new Date(reading.year, reading.month - 1, 1)\r\n  dueDate.setDate(dueDate.getDate() + 14)\r\n\r\n  const periodStart = new Date(reading.year, reading.month - 1, 1)\r\n  const periodEnd = new Date(reading.year, reading.month, 1)\r\n\r\n  const existingInvoice = await prisma.invoice.findFirst({\r\n    where: {\r\n      applicationId,\r\n      type: \"monthly_bill\",\r\n      dueDate: { gte: periodStart, lt: periodEnd },\r\n    },\r\n  })\r\n\r\n  const invoice =\r\n    existingInvoice ??\r\n    (await prisma.invoice.create({\r\n      data: {\r\n        applicationId,\r\n        customerId: application.customerId,\r\n        type: \"monthly_bill\",\r\n        description: `${dueDate.toLocaleString(\"default\", { month: \"long\" })} Net Metering Bill`,\r\n        amount,\r\n        status: \"pending\",\r\n        dueDate,\r\n      },\r\n    }))\r\n\r\n  if (!invoice.pdfUrl) {\r\n    const pdfBuffer = buildReportPdf({\r\n      title: \"SolarConnect Invoice\",\r\n      subtitle: `Invoice ${invoice.id}`,\r\n      sections: [\r\n        {\r\n          title: \"Invoice Details\",\r\n          lines: [\r\n            { label: \"Application\", value: application.reference },\r\n            { label: \"Type\", value: \"monthly bill\" },\r\n            { label: \"Description\", value: invoice.description },\r\n            { label: \"Amount\", value: `LKR ${Number(amount).toLocaleString()}` },\r\n            { label: \"Status\", value: invoice.status },\r\n            { label: \"Due Date\", value: invoice.dueDate.toLocaleDateString() },\r\n          ],\r\n        },\r\n      ],\r\n      footer: \"SolarConnect - Generated electronically.\",\r\n    })\r\n    const pdfUrl = await writePdfToPublic({\r\n      filename: `invoice-${invoice.id}.pdf`,\r\n      buffer: pdfBuffer,\r\n    })\r\n    await prisma.invoice.update({\r\n      where: { id: invoice.id },\r\n      data: { pdfUrl },\r\n    })\r\n  }\r\n\r\n  return NextResponse.json({ reading, invoice }, { status: 201 })\r\n}\r\n"],"names":[],"mappings":"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"}}]
}