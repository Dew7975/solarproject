{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\r\n\r\nconst globalForPrisma = globalThis as unknown as {\r\n  prisma?: PrismaClient\r\n}\r\n\r\nexport const prisma =\r\n  globalForPrisma.prisma ??\r\n  new PrismaClient({\r\n    log:\r\n      process.env.NODE_ENV === \"development\"\r\n        ? [\"error\", \"warn\"]\r\n        : [\"error\"],\r\n  })\r\n\r\nif (process.env.NODE_ENV !== \"production\") {\r\n  globalForPrisma.prisma = prisma\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KACE,uCACI;QAAC;QAAS;KAAO,GACjB;AACR;AAEF,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B"}},
    {"offset": {"line": 96, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/lib/auth-server.ts"],"sourcesContent":["import { cookies } from \"next/headers\"\r\nimport \"server-only\"\r\nimport { NextResponse } from \"next/server\"\r\nimport { randomUUID } from \"crypto\"\r\nimport { SignJWT, jwtVerify } from \"jose\"\r\nimport bcrypt from \"bcryptjs\"\r\nimport { prisma } from \"./prisma\"\r\nimport { UserRole } from \"@prisma/client\"\r\n\r\nconst SESSION_COOKIE = \"session_token\"\r\nconst SESSION_DURATION_MS = 1000 * 60 * 60 * 24 * 7\r\n\r\nfunction getSecret() {\r\n  const secret = process.env.JWT_SECRET\r\n  if (!secret) {\r\n    throw new Error(\"Missing JWT_SECRET\")\r\n  }\r\n  return new TextEncoder().encode(secret)\r\n}\r\n\r\nexport async function hashPassword(password: string) {\r\n  return bcrypt.hash(password, 10)\r\n}\r\n\r\nexport async function verifyPassword(password: string, hash: string) {\r\n  return bcrypt.compare(password, hash)\r\n}\r\n\r\nexport async function createAuthSession(userId: string, role: UserRole) {\r\n  const token = randomUUID()\r\n  const expiresAt = new Date(Date.now() + SESSION_DURATION_MS)\r\n\r\n  await prisma.session.create({\r\n    data: {\r\n      token,\r\n      userId,\r\n      expiresAt,\r\n    },\r\n  })\r\n\r\n  const jwt = await new SignJWT({ token, role })\r\n    .setProtectedHeader({ alg: \"HS256\" })\r\n    .setExpirationTime(expiresAt)\r\n    .sign(getSecret())\r\n\r\n  const cookieStore = await cookies()\r\n  cookieStore.set(SESSION_COOKIE, jwt, {\r\n    httpOnly: true,\r\n    sameSite: \"lax\",\r\n    expires: expiresAt,\r\n    path: \"/\",\r\n    secure: process.env.NODE_ENV === \"production\",\r\n  })\r\n  return token\r\n}\r\n\r\nexport async function clearSession() {\r\n  const cookieStore = await cookies()\r\n  const token = cookieStore.get(SESSION_COOKIE)?.value\r\n  if (token) {\r\n    await prisma.session.deleteMany({ where: { token } })\r\n  }\r\n  cookieStore.delete(SESSION_COOKIE)\r\n}\r\n\r\nexport async function getSessionUser() {\r\n  const cookieStore = await cookies()\r\n  const jwt = cookieStore.get(SESSION_COOKIE)?.value\r\n  if (!jwt) return null\r\n\r\n  try {\r\n    const { payload } = await jwtVerify(jwt, getSecret())\r\n    const token = payload.token as string\r\n    if (!token) return null\r\n    const session = await prisma.session.findUnique({\r\n      where: { token },\r\n      include: {\r\n        user: {\r\n          include: { organization: { select: { id: true, name: true, isRejected: true } } },\r\n        },\r\n      },\r\n    })\r\n    if (!session || session.expiresAt < new Date()) {\r\n      return null\r\n    }\r\n    if (session.user.status === \"suspended\") {\r\n      await prisma.session.deleteMany({ where: { token } })\r\n      cookieStore.delete(SESSION_COOKIE)\r\n      return null\r\n    }\r\n    return session.user\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\nexport function requireRole(userRole: UserRole, allowed: UserRole[]) {\r\n  if (!allowed.includes(userRole)) {\r\n    return NextResponse.json({ error: \"Forbidden\" }, { status: 403 })\r\n  }\r\n  return null\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;;;;;;;;AAGA,MAAM,iBAAiB;AACvB,MAAM,sBAAsB,OAAO,KAAK,KAAK,KAAK;AAElD,SAAS;IACP,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU;IACrC,IAAI,CAAC,QAAQ;QACX,MAAM,IAAI,MAAM;IAClB;IACA,OAAO,IAAI,cAAc,MAAM,CAAC;AAClC;AAEO,eAAe,aAAa,QAAgB;IACjD,OAAO,+KAAM,CAAC,IAAI,CAAC,UAAU;AAC/B;AAEO,eAAe,eAAe,QAAgB,EAAE,IAAY;IACjE,OAAO,+KAAM,CAAC,OAAO,CAAC,UAAU;AAClC;AAEO,eAAe,kBAAkB,MAAc,EAAE,IAAc;IACpE,MAAM,QAAQ,IAAA,mHAAU;IACxB,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK;IAExC,MAAM,0JAAM,CAAC,OAAO,CAAC,MAAM,CAAC;QAC1B,MAAM;YACJ;YACA;YACA;QACF;IACF;IAEA,MAAM,MAAM,MAAM,IAAI,wMAAO,CAAC;QAAE;QAAO;IAAK,GACzC,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,iBAAiB,CAAC,WAClB,IAAI,CAAC;IAER,MAAM,cAAc,MAAM,IAAA,6KAAO;IACjC,YAAY,GAAG,CAAC,gBAAgB,KAAK;QACnC,UAAU;QACV,UAAU;QACV,SAAS;QACT,MAAM;QACN,QAAQ,oDAAyB;IACnC;IACA,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,6KAAO;IACjC,MAAM,QAAQ,YAAY,GAAG,CAAC,iBAAiB;IAC/C,IAAI,OAAO;QACT,MAAM,0JAAM,CAAC,OAAO,CAAC,UAAU,CAAC;YAAE,OAAO;gBAAE;YAAM;QAAE;IACrD;IACA,YAAY,MAAM,CAAC;AACrB;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,6KAAO;IACjC,MAAM,MAAM,YAAY,GAAG,CAAC,iBAAiB;IAC7C,IAAI,CAAC,KAAK,OAAO;IAEjB,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,4MAAS,EAAC,KAAK;QACzC,MAAM,QAAQ,QAAQ,KAAK;QAC3B,IAAI,CAAC,OAAO,OAAO;QACnB,MAAM,UAAU,MAAM,0JAAM,CAAC,OAAO,CAAC,UAAU,CAAC;YAC9C,OAAO;gBAAE;YAAM;YACf,SAAS;gBACP,MAAM;oBACJ,SAAS;wBAAE,cAAc;4BAAE,QAAQ;gCAAE,IAAI;gCAAM,MAAM;gCAAM,YAAY;4BAAK;wBAAE;oBAAE;gBAClF;YACF;QACF;QACA,IAAI,CAAC,WAAW,QAAQ,SAAS,GAAG,IAAI,QAAQ;YAC9C,OAAO;QACT;QACA,IAAI,QAAQ,IAAI,CAAC,MAAM,KAAK,aAAa;YACvC,MAAM,0JAAM,CAAC,OAAO,CAAC,UAAU,CAAC;gBAAE,OAAO;oBAAE;gBAAM;YAAE;YACnD,YAAY,MAAM,CAAC;YACnB,OAAO;QACT;QACA,OAAO,QAAQ,IAAI;IACrB,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,SAAS,YAAY,QAAkB,EAAE,OAAmB;IACjE,IAAI,CAAC,QAAQ,QAAQ,CAAC,WAAW;QAC/B,OAAO,iLAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;IACjE;IACA,OAAO;AACT"}},
    {"offset": {"line": 235, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/lib/pdf.ts"],"sourcesContent":["function escapePdfText(value: string) {\r\n  return value.replace(/\\\\/g, \"\\\\\\\\\").replace(/\\(/g, \"\\\\(\").replace(/\\)/g, \"\\\\)\")\r\n}\r\n\r\ntype PdfSection = {\r\n  title: string\r\n  lines: { label: string; value: string }[]\r\n}\r\n\r\nexport function buildSimplePdf(title: string, lines: string[]) {\r\n  const contentLines = [\r\n    \"BT\",\r\n    \"/F1 18 Tf\",\r\n    \"72 740 Td\",\r\n    `(${escapePdfText(title)}) Tj`,\r\n    \"/F1 12 Tf\",\r\n    \"16 TL\",\r\n    ...lines.map((line) => `T* (${escapePdfText(line)}) Tj`),\r\n    \"ET\",\r\n  ].join(\"\\n\")\r\n\r\n  const objects: string[] = []\r\n  objects[1] = \"1 0 obj\\n<< /Type /Catalog /Pages 2 0 R >>\\nendobj\\n\"\r\n  objects[2] = \"2 0 obj\\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\\nendobj\\n\"\r\n  objects[3] =\r\n    \"3 0 obj\\n<< /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Contents 4 0 R /Resources << /Font << /F1 5 0 R >> >> >>\\nendobj\\n\"\r\n  objects[4] =\r\n    `4 0 obj\\n<< /Length ${Buffer.byteLength(contentLines, \"utf8\")} >>\\nstream\\n${contentLines}\\nendstream\\nendobj\\n`\r\n  objects[5] =\r\n    \"5 0 obj\\n<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>\\nendobj\\n\"\r\n\r\n  let pdf = \"%PDF-1.4\\n\"\r\n  const offsets: number[] = [0]\r\n  for (let i = 1; i <= 5; i += 1) {\r\n    offsets[i] = pdf.length\r\n    pdf += objects[i]\r\n  }\r\n  const xrefStart = pdf.length\r\n  pdf += \"xref\\n0 6\\n0000000000 65535 f \\n\"\r\n  for (let i = 1; i <= 5; i += 1) {\r\n    pdf += `${String(offsets[i]).padStart(10, \"0\")} 00000 n \\n`\r\n  }\r\n  pdf += \"trailer\\n<< /Size 6 /Root 1 0 R >>\\nstartxref\\n\"\r\n  pdf += `${xrefStart}\\n%%EOF\\n`\r\n  return Buffer.from(pdf, \"utf8\")\r\n}\r\n\r\nexport function buildReportPdf({\r\n  title,\r\n  subtitle,\r\n  sections,\r\n  footer,\r\n}: {\r\n  title: string\r\n  subtitle?: string\r\n  sections: PdfSection[]\r\n  footer?: string\r\n}) {\r\n  const content: string[] = []\r\n\r\n  // Header background\r\n  content.push(\"0.93 0.97 0.99 rg\")\r\n  content.push(\"0 720 612 72 re f\")\r\n\r\n  // Title\r\n  content.push(\"0 0 0 rg\")\r\n  content.push(\"BT\")\r\n  content.push(\"/F1 18 Tf\")\r\n  content.push(\"72 760 Td\")\r\n  content.push(`(${escapePdfText(title)}) Tj`)\r\n  if (subtitle) {\r\n    content.push(\"/F1 10 Tf\")\r\n    content.push(\"0 -18 Td\")\r\n    content.push(`(${escapePdfText(subtitle)}) Tj`)\r\n  }\r\n  content.push(\"ET\")\r\n\r\n  let y = 680\r\n  sections.forEach((section) => {\r\n    content.push(\"BT\")\r\n    content.push(\"/F1 12 Tf\")\r\n    content.push(`72 ${y} Td`)\r\n    content.push(`(${escapePdfText(section.title)}) Tj`)\r\n    content.push(\"ET\")\r\n    y -= 16\r\n\r\n    section.lines.forEach((line) => {\r\n      content.push(\"BT\")\r\n      content.push(\"/F1 10 Tf\")\r\n      content.push(`72 ${y} Td`)\r\n      content.push(`(${escapePdfText(line.label)}) Tj`)\r\n      content.push(\"ET\")\r\n      content.push(\"BT\")\r\n      content.push(\"/F1 10 Tf\")\r\n      content.push(`360 ${y} Td`)\r\n      content.push(`(${escapePdfText(line.value)}) Tj`)\r\n      content.push(\"ET\")\r\n      y -= 14\r\n    })\r\n\r\n    y -= 10\r\n    content.push(\"0.85 0.85 0.85 RG\")\r\n    content.push(`72 ${y} m 540 ${y} l S`)\r\n    y -= 14\r\n  })\r\n\r\n  if (footer) {\r\n    content.push(\"0 0 0 rg\")\r\n    content.push(\"BT\")\r\n    content.push(\"/F1 9 Tf\")\r\n    content.push(`72 ${y} Td`)\r\n    content.push(`(${escapePdfText(footer)}) Tj`)\r\n    content.push(\"ET\")\r\n  }\r\n\r\n  const contentLines = content.join(\"\\n\")\r\n\r\n  const objects: string[] = []\r\n  objects[1] = \"1 0 obj\\n<< /Type /Catalog /Pages 2 0 R >>\\nendobj\\n\"\r\n  objects[2] = \"2 0 obj\\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\\nendobj\\n\"\r\n  objects[3] =\r\n    \"3 0 obj\\n<< /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Contents 4 0 R /Resources << /Font << /F1 5 0 R >> >> >>\\nendobj\\n\"\r\n  objects[4] =\r\n    `4 0 obj\\n<< /Length ${Buffer.byteLength(contentLines, \"utf8\")} >>\\nstream\\n${contentLines}\\nendstream\\nendobj\\n`\r\n  objects[5] =\r\n    \"5 0 obj\\n<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>\\nendobj\\n\"\r\n\r\n  let pdf = \"%PDF-1.4\\n\"\r\n  const offsets: number[] = [0]\r\n  for (let i = 1; i <= 5; i += 1) {\r\n    offsets[i] = pdf.length\r\n    pdf += objects[i]\r\n  }\r\n  const xrefStart = pdf.length\r\n  pdf += \"xref\\n0 6\\n0000000000 65535 f \\n\"\r\n  for (let i = 1; i <= 5; i += 1) {\r\n    pdf += `${String(offsets[i]).padStart(10, \"0\")} 00000 n \\n`\r\n  }\r\n  pdf += \"trailer\\n<< /Size 6 /Root 1 0 R >>\\nstartxref\\n\"\r\n  pdf += `${xrefStart}\\n%%EOF\\n`\r\n  return Buffer.from(pdf, \"utf8\")\r\n}\r\n\r\nexport async function writePdfToPublic({\r\n  filename,\r\n  buffer,\r\n}: {\r\n  filename: string\r\n  buffer: Buffer\r\n}) {\r\n  const { promises: fs } = await import(\"fs\")\r\n  const path = await import(\"path\")\r\n  const dir = path.join(process.cwd(), \"public\", \"pdfs\")\r\n  await fs.mkdir(dir, { recursive: true })\r\n  const filePath = path.join(dir, filename)\r\n  await fs.writeFile(filePath, buffer)\r\n  return `/pdfs/${filename}`\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 370, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dew/404SquadSolarConnect/final/app/api/orders/%5Bid%5D/report/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { getSessionUser } from \"@/lib/auth-server\"\r\nimport { buildReportPdf } from \"@/lib/pdf\"\r\n\r\nexport async function GET(\r\n  _: NextRequest,\r\n  context: { params: Promise<{ id: string }> },\r\n) {\r\n  const { id } = await context.params\r\n  const user = await getSessionUser()\r\n  if (!user) {\r\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\r\n  }\r\n\r\n  const application = await prisma.application.findFirst({\r\n    where: { OR: [{ id }, { reference: id }] },\r\n    include: {\r\n      customer: true,\r\n      installerOrganization: true,\r\n      selectedPackage: true,\r\n    },\r\n  })\r\n\r\n  if (!application) {\r\n    return NextResponse.json({ error: \"Order not found\" }, { status: 404 })\r\n  }\r\n\r\n  if (user.role === \"customer\") {\r\n    return NextResponse.json({ error: \"Forbidden\" }, { status: 403 })\r\n  }\r\n\r\n  if (user.role === \"installer\") {\r\n    if (!user.organizationId || application.installerOrganizationId !== user.organizationId) {\r\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 })\r\n    }\r\n  }\r\n\r\n  const pdf = buildReportPdf({\r\n    title: \"Installation Order Report\",\r\n    subtitle: application.reference,\r\n    sections: [\r\n      {\r\n        title: \"Customer\",\r\n        lines: [\r\n          { label: \"Name\", value: application.customer?.name ?? \"N/A\" },\r\n          { label: \"Phone\", value: application.customer?.phone ?? \"N/A\" },\r\n          { label: \"Email\", value: application.customer?.email ?? \"N/A\" },\r\n          { label: \"Address\", value: application.customer?.address ?? \"N/A\" },\r\n        ],\r\n      },\r\n      {\r\n        title: \"Installation\",\r\n        lines: [\r\n          { label: \"Installer\", value: application.installerOrganization?.name ?? \"N/A\" },\r\n          { label: \"Package\", value: application.selectedPackage?.name ?? \"N/A\" },\r\n          { label: \"Status\", value: application.status },\r\n          { label: \"Site Visit\", value: application.siteVisitDate?.toLocaleString() ?? \"N/A\" },\r\n          { label: \"Updated\", value: application.updatedAt.toLocaleDateString() },\r\n        ],\r\n      },\r\n    ],\r\n    footer: \"SolarConnect - Generated electronically.\",\r\n  })\r\n\r\n  return new NextResponse(pdf, {\r\n    headers: {\r\n      \"Content-Type\": \"application/pdf\",\r\n      \"Content-Disposition\": `attachment; filename=\"order-${application.reference}.pdf\"`,\r\n      \"Cache-Control\": \"no-store\",\r\n    },\r\n  })\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEO,eAAe,IACpB,CAAc,EACd,OAA4C;IAE5C,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,QAAQ,MAAM;IACnC,MAAM,OAAO,MAAM,IAAA,0KAAc;IACjC,IAAI,CAAC,MAAM;QACT,OAAO,iLAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;IAEA,MAAM,cAAc,MAAM,0JAAM,CAAC,WAAW,CAAC,SAAS,CAAC;QACrD,OAAO;YAAE,IAAI;gBAAC;oBAAE;gBAAG;gBAAG;oBAAE,WAAW;gBAAG;aAAE;QAAC;QACzC,SAAS;YACP,UAAU;YACV,uBAAuB;YACvB,iBAAiB;QACnB;IACF;IAEA,IAAI,CAAC,aAAa;QAChB,OAAO,iLAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAkB,GAAG;YAAE,QAAQ;QAAI;IACvE;IAEA,IAAI,KAAK,IAAI,KAAK,YAAY;QAC5B,OAAO,iLAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;IACjE;IAEA,IAAI,KAAK,IAAI,KAAK,aAAa;QAC7B,IAAI,CAAC,KAAK,cAAc,IAAI,YAAY,uBAAuB,KAAK,KAAK,cAAc,EAAE;YACvF,OAAO,iLAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAY,GAAG;gBAAE,QAAQ;YAAI;QACjE;IACF;IAEA,MAAM,MAAM,IAAA,+JAAc,EAAC;QACzB,OAAO;QACP,UAAU,YAAY,SAAS;QAC/B,UAAU;YACR;gBACE,OAAO;gBACP,OAAO;oBACL;wBAAE,OAAO;wBAAQ,OAAO,YAAY,QAAQ,EAAE,QAAQ;oBAAM;oBAC5D;wBAAE,OAAO;wBAAS,OAAO,YAAY,QAAQ,EAAE,SAAS;oBAAM;oBAC9D;wBAAE,OAAO;wBAAS,OAAO,YAAY,QAAQ,EAAE,SAAS;oBAAM;oBAC9D;wBAAE,OAAO;wBAAW,OAAO,YAAY,QAAQ,EAAE,WAAW;oBAAM;iBACnE;YACH;YACA;gBACE,OAAO;gBACP,OAAO;oBACL;wBAAE,OAAO;wBAAa,OAAO,YAAY,qBAAqB,EAAE,QAAQ;oBAAM;oBAC9E;wBAAE,OAAO;wBAAW,OAAO,YAAY,eAAe,EAAE,QAAQ;oBAAM;oBACtE;wBAAE,OAAO;wBAAU,OAAO,YAAY,MAAM;oBAAC;oBAC7C;wBAAE,OAAO;wBAAc,OAAO,YAAY,aAAa,EAAE,oBAAoB;oBAAM;oBACnF;wBAAE,OAAO;wBAAW,OAAO,YAAY,SAAS,CAAC,kBAAkB;oBAAG;iBACvE;YACH;SACD;QACD,QAAQ;IACV;IAEA,OAAO,IAAI,iLAAY,CAAC,KAAK;QAC3B,SAAS;YACP,gBAAgB;YAChB,uBAAuB,CAAC,4BAA4B,EAAE,YAAY,SAAS,CAAC,KAAK,CAAC;YAClF,iBAAiB;QACnB;IACF;AACF"}}]
}