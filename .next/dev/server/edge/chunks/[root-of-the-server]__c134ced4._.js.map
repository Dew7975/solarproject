{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/404SquadSolarConnect/final/middleware.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport type { NextRequest } from \"next/server\";\r\nimport { jwtVerify } from \"jose\";\r\n\r\nconst SESSION_COOKIE = \"session_token\";\r\n\r\nconst protectedRoutes: Array<{\r\n  prefix: string;\r\n  role: \"customer\" | \"installer\" | \"officer\";\r\n}> = [\r\n  { prefix: \"/customer\", role: \"customer\" },\r\n  { prefix: \"/installer\", role: \"installer\" },\r\n  { prefix: \"/officer\", role: \"officer\" },\r\n];\r\n\r\nfunction getSecret() {\r\n  const secret = process.env.JWT_SECRET;\r\n  if (!secret) {\r\n    throw new Error(\"Missing JWT_SECRET\");\r\n  }\r\n  return new TextEncoder().encode(secret);\r\n}\r\n\r\nexport async function middleware(request: NextRequest) {\r\n  const { pathname } = request.nextUrl;\r\n\r\n  const matched = protectedRoutes.find(({ prefix }) =>\r\n    pathname.startsWith(prefix)\r\n  );\r\n\r\n  if (!matched) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  const jwt = request.cookies.get(SESSION_COOKIE)?.value;\r\n\r\n  if (!jwt) {\r\n    const url = new URL(\"/login\", request.url);\r\n    url.searchParams.set(\"redirect\", pathname);\r\n    return NextResponse.redirect(url);\r\n  }\r\n\r\n  try {\r\n    // Verify JWT token (works in Edge Runtime)\r\n    const { payload } = await jwtVerify(jwt, getSecret());\r\n    const role = payload.role as string;\r\n\r\n    if (role !== matched.role) {\r\n      return NextResponse.redirect(new URL(\"/\", request.url));\r\n    }\r\n\r\n    return NextResponse.next();\r\n  } catch (error) {\r\n    // Invalid or expired JWT\r\n    const url = new URL(\"/login\", request.url);\r\n    url.searchParams.set(\"redirect\", pathname);\r\n    return NextResponse.redirect(url);\r\n  }\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\"/customer/:path*\", \"/installer/:path*\", \"/officer/:path*\"],\r\n};\r\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AAEA;;;AAEA,MAAM,iBAAiB;AAEvB,MAAM,kBAGD;IACH;QAAE,QAAQ;QAAa,MAAM;IAAW;IACxC;QAAE,QAAQ;QAAc,MAAM;IAAY;IAC1C;QAAE,QAAQ;QAAY,MAAM;IAAU;CACvC;AAED,SAAS;IACP,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU;IACrC,IAAI,CAAC,QAAQ;QACX,MAAM,IAAI,MAAM;IAClB;IACA,OAAO,IAAI,cAAc,MAAM,CAAC;AAClC;AAEO,eAAe,WAAW,OAAoB;IACnD,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IAEpC,MAAM,UAAU,gBAAgB,IAAI,CAAC,CAAC,EAAE,MAAM,EAAE,GAC9C,SAAS,UAAU,CAAC;IAGtB,IAAI,CAAC,SAAS;QACZ,OAAO,iOAAY,CAAC,IAAI;IAC1B;IAEA,MAAM,MAAM,QAAQ,OAAO,CAAC,GAAG,CAAC,iBAAiB;IAEjD,IAAI,CAAC,KAAK;QACR,MAAM,MAAM,IAAI,IAAI,UAAU,QAAQ,GAAG;QACzC,IAAI,YAAY,CAAC,GAAG,CAAC,YAAY;QACjC,OAAO,iOAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,IAAI;QACF,2CAA2C;QAC3C,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,8MAAS,EAAC,KAAK;QACzC,MAAM,OAAO,QAAQ,IAAI;QAEzB,IAAI,SAAS,QAAQ,IAAI,EAAE;YACzB,OAAO,iOAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,KAAK,QAAQ,GAAG;QACvD;QAEA,OAAO,iOAAY,CAAC,IAAI;IAC1B,EAAE,OAAO,OAAO;QACd,yBAAyB;QACzB,MAAM,MAAM,IAAI,IAAI,UAAU,QAAQ,GAAG;QACzC,IAAI,YAAY,CAAC,GAAG,CAAC,YAAY;QACjC,OAAO,iOAAY,CAAC,QAAQ,CAAC;IAC/B;AACF;AAEO,MAAM,SAAS;IACpB,SAAS;QAAC;QAAoB;QAAqB;KAAkB;AACvE"}}]
}