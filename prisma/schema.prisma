generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum UserRole {
  customer
  installer
  officer
}

enum UserStatus {
  active
  suspended
}

enum ApplicationStatus {
  pending
  under_review
  pre_visit_approved
  site_visit_payment_completed
  site_visit_scheduled
  approved
  rejected
  payment_pending
  payment_confirmed
  finding_installer
  installation_in_progress
  installation_complete
  final_inspection
  agreement_pending
  inspection_approved
  agreement_sent
  customer_signed
  installer_signed
  officer_final_approved
  completed
}

enum BidStatus {
  pending
  accepted
  rejected
  expired
}

enum BidSessionStatus {
  open
  closed
  expired
}

enum BidType {
  open
  specific
}

enum InvoiceStatus {
  pending
  paid
  overdue
}

enum InvoiceType {
  authority_fee
  installation
  monthly_bill
}

enum AgreementStatus {
  draft
  sent
  customer_signed
  installer_signed
  officer_approved
}

enum CalibrationStatus {
  SCHEDULED
  COMPLETED
}

model User {
  id              String     @id @default(cuid())
  email           String     @unique
  passwordHash    String
  name            String
  role            UserRole
  status          UserStatus @default(active)
  phone           String?
  address         String?
  profileImageUrl String?
  verified        Boolean    @default(false)

  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?

  applications  Application[]  @relation("CustomerApplications")
  bidSessions   BidSession[]   @relation("CustomerBidSessions")
  bids          Bid[]
  invoices      Invoice[]
  meterReadings MeterReading[]
  notifications Notification[]
  agreements    Agreement[]
  sessions      Session[]

  reviews Review[] // <-- added

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Organization {
  id                     String    @id @default(cuid())
  name                   String
  registrationNumber     String?
  description            String?
  address                String?
  phone                  String?
  verified               Boolean   @default(false)
  isRejected             Boolean   @default(false)
  verifiedAt             DateTime?
  rating                 Float     @default(0)
  completedInstallations Int       @default(0)
  documents              String[]  @default([])

  users        User[]
  packages     InstallerPackage[]
  bids         Bid[]
  applications Application[]      @relation("InstallerApplications")
  agreements   Agreement[]

  reviews Review[] // <-- added

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Application {
  id        String @id @default(cuid())
  reference String @unique

  customer   User   @relation("CustomerApplications", fields: [customerId], references: [id])
  customerId String

  installerOrganization   Organization? @relation("InstallerApplications", fields: [installerOrganizationId], references: [id])
  installerOrganizationId String?

  selectedPackage   InstallerPackage? @relation("PackageSelections", fields: [selectedPackageId], references: [id])
  selectedPackageId String?

  status          ApplicationStatus @default(pending)
  siteVisitDate   DateTime?
  rejectionReason String?

  documents        Json
  technicalDetails Json

  bids          Bid[]
  bidSessions   BidSession[]
  invoices      Invoice[]
  meterReadings MeterReading[]
  agreements    Agreement[]
  calibrations  Calibration[]

  reviews Review[] // <-- added

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InstallerPackage {
  id             String       @id @default(cuid())
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  name             String
  capacity         String
  description      String?
  panelCount       Int
  panelType        String
  inverterType     String?
  inverterBrand    String
  installationDays Int?
  warranty         String
  price            Int
  active           Boolean  @default(true)
  features         String[]

  bids         Bid[]
  bidSessions  BidSession[]
  applications Application[] @relation("PackageSelections")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BidSession {
  id            String      @id @default(cuid())
  application   Application @relation(fields: [applicationId], references: [id])
  applicationId String

  customer   User   @relation("CustomerBidSessions", fields: [customerId], references: [id])
  customerId String

  status       BidSessionStatus @default(open)
  bidType      BidType?
  requirements String?
  maxBudget    Int?

  startedAt DateTime @default(now())
  expiresAt DateTime

  bids Bid[]

  selectedPackage   InstallerPackage? @relation(fields: [selectedPackageId], references: [id])
  selectedPackageId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Bid {
  id            String      @id @default(cuid())
  application   Application @relation(fields: [applicationId], references: [id])
  applicationId String

  bidSession   BidSession? @relation(fields: [bidSessionId], references: [id])
  bidSessionId String?

  installer   User?   @relation(fields: [installerId], references: [id])
  installerId String?

  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?

  package   InstallerPackage? @relation(fields: [packageId], references: [id])
  packageId String?

  price         Int
  proposal      String
  warranty      String
  estimatedDays Int
  status        BidStatus @default(pending)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id            String      @id @default(cuid())
  application   Application @relation(fields: [applicationId], references: [id])
  applicationId String

  customer   User   @relation(fields: [customerId], references: [id])
  customerId String

  amount      Int
  description String
  dueDate     DateTime
  status      InvoiceStatus @default(pending)
  type        InvoiceType
  paidAt      DateTime?
  pdfUrl      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MeterReading {
  id            String      @id @default(cuid())
  application   Application @relation(fields: [applicationId], references: [id])
  applicationId String

  user   User   @relation(fields: [userId], references: [id])
  userId String

  month        Int
  year         Int
  kwhGenerated Float
  kwhExported  Float
  kwhImported  Float

  createdAt DateTime @default(now())
}

model Notification {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String

  title String
  body  String
  link  String?
  read  Boolean @default(false)

  createdAt DateTime @default(now())
}

model Agreement {
  id            String      @id @default(cuid())
  application   Application @relation(fields: [applicationId], references: [id])
  applicationId String

  customer   User   @relation(fields: [customerId], references: [id])
  customerId String

  installerOrganization   Organization? @relation(fields: [installerOrganizationId], references: [id])
  installerOrganizationId String?

  status AgreementStatus @default(draft)

  customerPdfUrl     String?
  installerPdfUrl    String?
  customerSignedUrl  String?
  installerSignedUrl String?
  customerSignedAt   DateTime?
  installerSignedAt  DateTime?
  sentAt             DateTime?
  officerApprovedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Session {
  id    String @id @default(cuid())
  token String @unique

  user   User   @relation(fields: [userId], references: [id])
  userId String

  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Calibration {
  id            String      @id @default(cuid())
  application   Application @relation(fields: [applicationId], references: [id])
  applicationId String

  scheduledAt DateTime
  completedAt DateTime?
  status      CalibrationStatus @default(SCHEDULED)

  checklist       Json?
  readings        Json?
  recommendations String?
  reportUrl       String?
  nextScheduledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Review {
  id String @id @default(cuid())

  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  applicationId String

  customer   User   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId String

  installerOrganization   Organization @relation(fields: [installerOrganizationId], references: [id], onDelete: Cascade)
  installerOrganizationId String

  rating  Int
  comment String?

  createdAt    DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([customerId, applicationId], name: "customerId_applicationId")
}